import streamlit as st
import pandas as pd
from docx import Document
from docx.shared import Cm, Pt
from docx.oxml.ns import qn
from docx.enum.table import WD_ROW_HEIGHT_RULE
from io import BytesIO

# --- è¨­å®šé é¢è³‡è¨Š ---
st.set_page_config(
    page_title="ç”Ÿæ—¥è³€å¡æ¨™ç±¤ç”Ÿæˆå™¨",
    page_icon="ğŸ·ï¸",
    layout="centered"
)

# --- è¼”åŠ©å‡½å¼ ---

def get_hualien_zip_code(address):
    """
    ä¾æ“šæ“ä½œæ‰‹å†Šé‚è¼¯ï¼Œåˆ¤å®šèŠ±è“®ç¸£å„é„‰é®éƒµéå€è™Ÿã€‚
    ä¾†æº: PDF Source [246]
    """
    zip_map = {
        "èŠ±è“®å¸‚": "970", "æ–°åŸé„‰": "971", "ç§€æ—é„‰": "972",
        "å‰å®‰é„‰": "973", "å£½è±é„‰": "974", "é³³æ—é®": "975",
        "å…‰å¾©é„‰": "976", "è±æ¿±é„‰": "977", "ç‘ç©—é„‰": "978",
        "è¬æ¦®é„‰": "979", "ç‰é‡Œé®": "981", "å“æºªé„‰": "982",
        "å¯Œé‡Œé„‰": "983"
    }
    
    # ç¢ºä¿åœ°å€æ˜¯å­—ä¸²ï¼Œé¿å…éŒ¯èª¤
    if not isinstance(address, str):
        return "   "

    for town, code in zip_map.items():
        if town in address:
            return code
    return "   "

def set_font(run, size=12, bold=False):
    """è¨­å®šå­—å‹ç‚ºæ¨™æ¥·é«” (ä¸­æ–‡) èˆ‡ Times New Roman (è¥¿æ–‡)"""
    run.font.name = 'Times New Roman'
    run._element.rPr.rFonts.set(qn('w:eastAsia'), 'æ¨™æ¥·é«”')
    run.font.size = Pt(size)
    run.font.bold = bold

def generate_word_doc(df):
    """
    ç”Ÿæˆ Word æ–‡ä»¶çš„æ ¸å¿ƒé‚è¼¯
    å›å‚³: BytesIO ç‰©ä»¶ (åœ¨è¨˜æ†¶é«”ä¸­çš„æª”æ¡ˆ)
    """
    doc = Document()
    
    # è¨­å®šç‰ˆé¢: A4 å¤§å°ï¼Œé‚Šç•Œå…¨ç‚º 0 [Source: 76, 88]
    section = doc.sections[0]
    section.page_height = Cm(29.7)
    section.page_width = Cm(21.0)
    section.top_margin = Cm(0)
    section.bottom_margin = Cm(0)
    section.left_margin = Cm(0)
    section.right_margin = Cm(0)

    # å»ºç«‹è¡¨æ ¼ (2æ¬„ x Nåˆ—)
    total_items = len(df)
    rows_needed = (total_items + 1) // 2 
    table = doc.add_table(rows=rows_needed, cols=2)
    
    for index, row_data in df.iterrows():
        r = index // 2
        c = index % 2
        
        # å–å¾—è³‡æ–™ä¸¦è½‰ç‚ºå­—ä¸²ï¼Œè™•ç†ç©ºå€¼
        name = str(row_data.get('å§“å', '')).strip()
        address = str(row_data.get('é€šè¨Šåœ°å€', '')).strip()
        
        if name == 'nan': name = ''
        if address == 'nan': address = ''
        
        zip_code = get_hualien_zip_code(address)
        
        # åœ°å€æ‹†åˆ†é‚è¼¯ [Source: 243]
        if len(address) > 6:
            township = address[:6]
            detail_addr = address[6:]
        else:
            township = address
            detail_addr = ""

        cell = table.rows[r].cells[c]
        cell.width = Cm(10.5) # [Source: 108]
        
        # å›ºå®šåˆ—é«˜ [Source: 104]
        table.rows[r].height_rule = WD_ROW_HEIGHT_RULE.EXACTLY
        table.rows[r].height = Cm(2.97) 

        cell.vertical_alignment = 1 # å‚ç›´ç½®ä¸­
        cell._element.clear_content() # æ¸…é™¤é è¨­æ®µè½
        
        p = cell.add_paragraph()
        p.paragraph_format.left_indent = Cm(0.5) # å·¦ç¸®æ’
        p.paragraph_format.space_before = Pt(10) # ä¸Šæ–¹é–“è·
        
        # ç¬¬ä¸€è¡Œï¼šéƒµéå€è™Ÿ + é„‰é®
        run1 = p.add_run(f"{zip_code} {township}\n")
        set_font(run1)
        
        # ç¬¬äºŒè¡Œï¼šè©³ç´°åœ°å€
        run2 = p.add_run(f"{detail_addr}\n")
        set_font(run2)
        
        # ç¬¬ä¸‰è¡Œï¼šå§“å + ç¨±è¬‚ [Source: 332]
        # é€™è£¡å¯ä»¥åŠ å…¥ç°¡å–®åˆ¤æ–·ï¼Œè‹¥æ¬„ä½æ²’è³‡æ–™å°±ä¸å°ã€Œæ”¶ã€
        if name:
            run3 = p.add_run(f"{name} å…ˆç”Ÿ/å¥³å£« æ”¶") 
            set_font(run3, size=14, bold=True)

    # å°‡æª”æ¡ˆå­˜å…¥è¨˜æ†¶é«” Buffer
    buffer = BytesIO()
    doc.save(buffer)
    buffer.seek(0)
    return buffer

# --- Streamlit UI ä»‹é¢ ---

st.title("ğŸ·ï¸ ç”Ÿæ—¥è³€å¡æ¨™ç±¤ç”Ÿæˆå™¨")
st.markdown("""
æœ¬å·¥å…·å¯å°‡ Excel é€šè¨ŠéŒ„è½‰æ›ç‚º **3M 21320 (A4 2æ¬„ x 10åˆ—)** æ ¼å¼çš„ Word æ¨™ç±¤æª”ã€‚
è«‹ä¸Šå‚³æ‚¨çš„ Excel æª”æ¡ˆé€²è¡Œè½‰æ›ã€‚
""")

st.info("ğŸ’¡ **æç¤º**ï¼šExcel æª”æ¡ˆå¿…é ˆåŒ…å« **ã€Œå§“åã€** èˆ‡ **ã€Œé€šè¨Šåœ°å€ã€** é€™å…©å€‹æ¬„ä½æ¨™é¡Œã€‚")

# 1. æª”æ¡ˆä¸Šå‚³å€
uploaded_file = st.file_uploader("ä¸Šå‚³ Excel æª”æ¡ˆ (.xlsx)", type=['xlsx'])

if uploaded_file is not None:
    try:
        # è®€å– Excel
        df = pd.read_excel(uploaded_file, dtype=str)
        
        # æª¢æŸ¥æ¬„ä½
        required_cols = {'å§“å', 'é€šè¨Šåœ°å€'}
        if not required_cols.issubset(df.columns):
            st.error(f"éŒ¯èª¤ï¼šExcel ç¼ºå°‘å¿…è¦æ¬„ä½ï¼è«‹ç¢ºèªæª”æ¡ˆä¸­åŒ…å«ï¼š{required_cols}")
            st.stop()
            
        # é¡¯ç¤ºå‰ 5 ç­†è³‡æ–™é è¦½
        st.subheader("ğŸ“‹ è³‡æ–™é è¦½ (å‰ 5 ç­†)")
        st.dataframe(df[['å§“å', 'é€šè¨Šåœ°å€']].head())
        st.write(f"å…±è®€å–åˆ° {len(df)} ç­†è³‡æ–™")

        # 2. ç”ŸæˆæŒ‰éˆ•
        if st.button("ğŸš€ é–‹å§‹ç”Ÿæˆæ¨™ç±¤", type="primary"):
            with st.spinner('æ­£åœ¨æ’ç‰ˆä¸¦ç”Ÿæˆ Word æª”...'):
                docx_buffer = generate_word_doc(df)
                
                st.success("âœ… æ¨™ç±¤ç”ŸæˆæˆåŠŸï¼è«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•ä¸‹è¼‰ã€‚")
                
                # 3. ä¸‹è¼‰æŒ‰éˆ•
                st.download_button(
                    label="ğŸ“¥ ä¸‹è¼‰ Word æ¨™ç±¤æª” (.docx)",
                    data=docx_buffer,
                    file_name="ç”Ÿæ—¥è³€å¡æ¨™ç±¤.docx",
                    mime="application/vnd.openxmlformats-officedocument.wordprocessingml.document"
                )
                
                st.warning("âš ï¸ **åˆ—å°æ³¨æ„**ï¼šåˆ—å° PDF æˆ– Word æ™‚ï¼Œè«‹å‹™å¿…é¸æ“‡ **ã€Œå¯¦éš›å¤§å° (Actual Size)ã€** æˆ–ç¸®æ”¾æ¯”ä¾‹ **100%**ï¼Œä»¥å…æ¨™ç±¤ä½ç½®è·‘æ‰ã€‚")

    except Exception as e:
        st.error(f"ç™¼ç”ŸéŒ¯èª¤ï¼š{e}")

# Footer
st.markdown("---")
st.caption("Designed for automated label processing.")